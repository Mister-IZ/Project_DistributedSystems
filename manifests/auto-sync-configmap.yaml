apiVersion: v1
kind: ConfigMap
metadata:
  name: auto-sync-script
  namespace: test
data:
  check-and-update.sh: |
    #!/bin/bash
    set -e

    NAMESPACE="test"
    DEPLOYMENT="demo-app"
    IMAGE_REPO="ibrahimmmm/demo-app"

    echo "üîç V√©rification des mises √† jour..."

    # R√©cup√®re l'image actuellement d√©ploy√©e
    CURRENT_IMAGE=$(kubectl get deployment $DEPLOYMENT -n $NAMESPACE -o jsonpath='{.spec.template.spec.containers[0].image}')
    echo "üì¶ Image actuelle : $CURRENT_IMAGE"

    # R√©cup√®re le dernier tag Git SHA sur Docker Hub (ignore "latest")
    LATEST_TAG=$(curl -s "https://hub.docker.com/v2/repositories/${IMAGE_REPO}/tags/?page_size=10" | jq -r '.results[] | select(.name != "latest") | .name' | head -1)

    if [ -z "$LATEST_TAG" ]; then
        echo "‚ùå Aucun tag trouv√© sur Docker Hub"
        exit 0
    fi

    LATEST_IMAGE="${IMAGE_REPO}:${LATEST_TAG}"
    echo "üÜï Derni√®re image : $LATEST_IMAGE"

    # Compare les NOMS d'images (simple et fiable !)
    if [ "$CURRENT_IMAGE" != "$LATEST_IMAGE" ]; then
        echo "üöÄ Nouvelle version d√©tect√©e ! Mise √† jour..."
        kubectl set image deployment/$DEPLOYMENT demo-app=$LATEST_IMAGE -n $NAMESPACE
        echo "‚úÖ D√©ploiement mis √† jour avec $LATEST_TAG"
    else
        echo "‚úÖ D√©ploiement d√©j√† √† jour."
    fi