apiVersion: v1
kind: ConfigMap
metadata:
  name: auto-sync-script
  namespace: test
data:
  check-and-update.sh: |
    #!/bin/bash
    set -e

    NAMESPACE="test"
    DEPLOYMENT="demo-app"
    IMAGE_REPO="ibrahimmmm/demo-app"

    echo "ðŸ” VÃ©rification des mises Ã  jour..."

    # RÃ©cupÃ¨re l'image actuellement dÃ©ployÃ©e
    CURRENT_IMAGE=$(kubectl get deployment $DEPLOYMENT -n $NAMESPACE -o jsonpath='{.spec.template.spec.containers[0].image}')

    echo "ðŸ“¦ Image dÃ©ployÃ©e : $CURRENT_IMAGE"

    # RÃ©cupÃ¨re le digest SHA de l'image latest sur Docker Hub
    LATEST_DIGEST=$(curl -s "https://hub.docker.com/v2/repositories/${IMAGE_REPO}/tags/latest" | jq -r '.images[0].digest' 2>/dev/null || echo "unknown")

    # RÃ©cupÃ¨re le digest de l'image actuelle (via les pods)
    CURRENT_DIGEST=$(kubectl get pods -n $NAMESPACE -l app=demo-app -o jsonpath='{.items[0].status.containerStatuses[0].imageID}' 2>/dev/null | cut -d'@' -f2 || echo "unknown")

    echo "ðŸ”„ Digest actuel : $CURRENT_DIGEST"
    echo "ðŸ†• Digest latest : $LATEST_DIGEST"

    # Si les digests sont diffÃ©rents, on restart
    if [ "$CURRENT_DIGEST" != "$LATEST_DIGEST" ] && [ "$LATEST_DIGEST" != "unknown" ] && [ "$LATEST_DIGEST" != "null" ]; then
        echo "ðŸš€ Nouvelle image dÃ©tectÃ©e ! Mise Ã  jour en cours..."
        kubectl rollout restart deployment/$DEPLOYMENT -n $NAMESPACE
        echo "âœ… RedÃ©marrage du dÃ©ploiement dÃ©clenchÃ© !"
    else
        echo "âœ… DÃ©ploiement dÃ©jÃ  Ã  jour."
    fi